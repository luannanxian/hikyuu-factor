

### **A股全市场量化因子挖掘与决策支持系统需求规格说明书 (V2.4 \- 开发规范版)**

---

#### **一、 战略定位与核心原则**

1. 系统定位：决策支持系统 (Decision Support System, DSS)  
   本系统的根本定位是一个为投资经理（PM）赋能的决策支持工具，而非自动化交易执行系统。其核心价值在于提供数据驱动、可解释、可验证的交易思路，以辅助而非取代专业投资决策。  
2. 核心约束：人工确认与风险控制  
   系统最严格的约束是：所有最终交易信号的生成，必须经过人工二次确认后方可触发。严禁任何形式的全自动交易流程，确保最终决策权和责任主体始终为投资经理。  
3. 技术基石：Hikyuu 高性能计算核心  
   系统的核心计算层与数据管理层将基于 Hikyuu 框架 实现 1。选择此框架是为充分利用其基于C++核心带来的高性能计算能力，特别是在处理大规模、长周期的因子计算与回测任务时 1。系统架构中的“Agent”设计模式，是在 Hikyuu 计算核心之上构建的应用层逻辑，旨在实现模块化和关注点分离。  
4. 标的范围与更新  
   覆盖沪深A股所有股票，并建立每日自动更新的股票池。系统需自动剔除ST/\*ST股及上市不足60交易日的新股。

---

#### **二、 数据层需求 (高风险区域强化)**

1. 数据源策略：聚焦核心，分步扩展  
   为加速一期核心功能的交付，数据源策略将进行调整。一期将完全采用 Hikyuu 的原生数据接口及内置数据引擎（MySQL）作为唯一数据来源 2。这将简化初始开发复杂度，确保核心计算与数据层的高度整合。所有外部数据的接入仍需通过统一的  
   AbstractDataProvider 接口实现，但一期仅实现针对 Hikyuu 内置数据源的适配器。对第三方数据服务商（如 Tushare、聚宽等）的接入将作为二期或之后的扩展功能，届时再引入数据源冗余机制。  
2. **基础行情数据 (日K线)**  
   * **来源**：优先使用 Hikyuu 原生接口获取。  
   * **字段**：必须包含复权处理后的开、高、收、低价格，以及成交量、成交额。  
   * **更新**：每日收盘后，通过定时任务自动更新至本地数据库。  
3. 关键修正：杜绝前视偏差 (Point-in-Time 数据)  
   为从根本上杜绝前视偏差这一重大回测谬误，所有具有发布延迟的非行情数据（尤其是财务数据、公告数据等），在数据库中必须同时记录其“报告期”和“实际发布日期 (publication\_timestamp)”。系统中所有因子验证与回测逻辑，在获取历史数据时，必须严格使用“实际发布日期”作为时间戳，确保在模拟的任一时间点，只能获取到当时已公开的信息。  
4. **财务数据**  
   * **来源**：通过 AbstractDataProvider 接口接入。  
   * **指标**：PE-TTM, PB, ROE, 营收增长率等核心估值与质量指标。  
   * **口径**：支持“最新财报”与“TTM滚动”两种可切换的计算口径，所有计算均需遵循上述 Point-in-Time 原则。  
5. **量价衍生数据 (资金流向)**  
   * **一期方案**：通过 AbstractDataProvider 接口，直接接入第三方API获取已计算好的主力资金流数据。  
   * **二期规划**：评估基于 Level-2 行情数据自行计算的可行性，作为独立的技术研究课题。  
6. **数据质量与校验**  
   * **预处理**：自动剔除ST股、上市不足60日的新股。  
   * **缺失值处理**：财务数据使用前一期已知值填充（向前填充），价格数据对停牌进行标记。所有经过填充或处理的数据点，必须在数据库中设有明确的is\_imputed或is\_missing标识。  
   * **校验与告警**：每日数据更新任务完成后，自动执行数据一致性与完整性校验。对价格、成交量等关键字段的日度变化设置阈值（如±30%），超出阈值则触发告警，并暂停后续依赖此数据的计算任务，等待人工干预。

**技术实现要点 (基于Hikyuu框架)**

* **数据获取与管理**：需遵循Hikyuu官方文档的指引，首先完成数据的下载与准备工作。  
* **Point-in-Time 实现**：Hikyuu 通过其事件驱动的回测引擎 (backtest 函数) 原生支持 Point-in-Time (PIT) 数据的正确处理。为严格避免前视偏差，所有策略开发**必须**遵循以下规范：  
  * 在策略逻辑（如 on\_bar 回调）中，**严禁**直接调用 stock.get\_kdata() 或 Datetime.now() 等可能引入未来数据的函数。  
  * **必须**使用策略上下文 (stg) 提供的专用方法来访问数据和时间，包括：stg.get\_kdata() 用于获取当前模拟时间点可用的历史K线数据，以及 stg.now() 获取当前模拟时间。  
  * 对于财务数据，应通过 FINANCE 指标在策略内部进行访问，确保数据仅在发布后才对策略可见。  
  * 此设计确保了即使数据被预加载以优化性能，策略逻辑也只能访问到在模拟时间点上已经历史可用的信息。  
* **数据质量校验**：利用Hikyuu与Numpy/Pandas之间便捷的数据结构转换能力 1，将K线或财务数据转换为DataFrame格式，再利用Pandas强大的数据分析功能进行完整性、一致性校验和异常值检测。

---

#### **三、 因子工程层需求**

1. 因子治理：经济逻辑优先  
   所有纳入因子库的因子，必须提供明确的经济逻辑或市场共识的文字说明。系统应禁止纯粹基于数据挖掘而无法提供合理解释的因子进入核心库，以此作为抵御过拟合的第一道防线。  
2. **因子计算与处理**  
   * **计算类型**：支持时间序列计算（如MA, MACD）和横截面计算。  
   * **标准化处理**：内置去极值（如中位数绝对偏差法）、标准化（Z-Score）、行业中性化等标准化处理模块。  
3. 关键澄清：横截面计算参数化  
   所有横截面计算（如行业排名、市值分位数）所依赖的股票池定义（例如，全市场、沪深300、中证500）和行业分类标准（例如，申万一级、GICS），必须作为明确的、可配置的、可版本化的系统参数进行管理，严禁在代码中硬编码。因子定义必须与其所使用的股票池和行业分类标准绑定。  
4. 因子版本化管理  
   因子元数据（名称、计算公式、作者、创建时间、依赖参数）需入库管理。任何对因子计算逻辑的修改，都必须生成一个新的因子版本，旧版本因子及其计算结果应予归档，确保所有历史研究和信号生成的可复现性。

**技术实现要点 (基于Hikyuu框架)**

* **时间序列因子**：可直接利用Hikyuu内置的大量技术指标函数（如EMA, MACD等），或其集成的talib库 1。自定义的时间序列因子可以通过组合现有指标或编写新的指标公式来实现。  
* **横截面因子**：Hikyuu文档未明确提供横截面分析的原生支持（如行业中性化、排名等） 3。因此，需自行实现此逻辑：在特定时间点，使用Hikyuu获取股票池内所有股票的数据，将其转换为Pandas DataFrame，利用  
  groupby()（按行业）、rank()（排名）等Pandas函数进行计算，最后将结果存回数据库。  
* **因子版本化**：此功能由应用层的数据库设计和管理逻辑保证，而非Hikyuu框架原生提供。

---

#### **四、 因子验证层需求 (范围澄清)**

1. 核心目标：验证因子预测能力  
   本模块的定位是因子有效性验证平台，而非完整的投资组合模拟引擎。其核心任务是回答“这个因子是否具备预测股票未来收益的能力？”，而非“基于此因子的投资组合表现如何？”。完整的组合回测作为二期或更远期的规划。  
2. 评估方法与样本划分  
   采用严格的样本外测试框架。默认时间划分为：训练集(2010-2016)、测试集(2017-2020)、验证集(2021-至今)。所有关键决策应基于训练集，并在测试集上进行验证。鼓励在最终报告中独立展示验证集的表现，以评估其在更近期市场的鲁棒性。  
3. **核心评估指标**  
   * **IC系列**：计算并展示 Rank IC 的均值、标准差（ICIR）、IC胜率、月度IC序列图。  
   * **分层收益分析**：按因子值将股票池分为5组或10组，计算并绘制各组在未来不同持有期（1日、5日、10日、20日）的平均收益、累计收益曲线。  
   * **多空组合分析**：计算Top-Bottom（第一组 vs 最后一组）组合的年化收益、夏普比率、最大回撤。  
   * **换手率分析**：评估因子在各分层中的换手率，作为交易成本的代理指标。  
4. 过拟合防控  
   主要通过严格的样本外测试（测试集与验证集表现）和参数敏感性分析来控制。系统需提供因子间的相关性矩阵计算功能，并自动标记相关系数绝对值高于0.7的因子对，以警示冗余。  
5. 自动化验证报告  
   提供一键生成标准化因子验证报告的功能，输出为PDF或HTML格式，包含所有核心评估指标的图表与表格。

**技术实现要点 (基于Hikyuu框架)**

* **数据准备**：使用Hikyuu高效获取指定时间范围内的因子值和未来收益率数据。  
* **指标计算**：将获取的数据转换为Numpy数组或Pandas Series，使用scipy.stats或numpy.corrcoef计算IC值。对于分层收益分析，利用Pandas的qcut进行分组，再对各组进行收益计算。  
* **结果可视化**：利用hikyuu.interactive模块结合matplotlib进行图表绘制，如IC序列图、分层累计收益图等，最终整合生成PDF报告。

---

#### **五、 系统架构与接口需求**

1. 架构模式：面向服务的Agent设计  
   系统采用模块化的Agent设计，逻辑上划分为：  
   * **主控调度Agent**：负责任务流编排、定时任务调度、异常处理与日志记录。  
   * **数据管理Agent**：负责所有数据的获取、清洗、存储、校验与服务化提供。  
   * **因子计算Agent**：负责因子值的计算、处理与存储。  
   * **因子验证Agent**：负责执行因子验证流程并生成报告。  
   * **信号生成Agent**：负责在人工触发后，执行最终计算并生成交易信号文件。  
2. 关键要求：Agent接口控制文档 (ICD)  
   在开发阶段，必须创建一份独立的接口控制文档，用以明确定义各Agent之间的交互协议。该文档需详细说明：  
   * **通信方式**：是采用同步的RESTful API，还是异步的消息队列。  
   * **数据格式**：定义API请求与响应的JSON Schema。  
   * **接口定义**：详细描述每个接口的功能、参数、返回值及错误码。  
3. 开发者接口 (Python SDK)  
   提供一套清晰、文档完备的Python SDK，供研究员进行交互式研究。核心函数应包括：  
   * get\_data(): 获取行情、财务等基础数据。  
   * get\_factor\_values(): 获取指定因子在特定时间截面的因子值。  
   * validate\_factor(): 调用因子验证Agent，执行完整的验证流程。  
   * generate\_trading\_signals(strategy\_id, trade\_date, confirm=True): **【人工触发核心】** 调用信号生成Agent，必须显式传入confirm=True并经过二次确认方可执行。  
4. 远期规划：Web界面  
   一期需预留RESTful API接口，为二期开发Web可视化界面（用于因子库管理、任务监控、报告查阅等）奠定基础。

**技术实现要点 (基于Hikyuu框架)**

* **Agent与Hikyuu关系**：Hikyuu作为底层计算引擎，被封装在各个Agent内部。例如，数据管理Agent调用Hikyuu获取数据，因子计算Agent调用Hikyuu执行指标计算。Agent之间通过定义的API通信，而不是直接调用Hikyuu。  
* **SDK实现**：SDK是对各Agent暴露的API的Python封装。例如，get\_data函数内部会调用数据管理Agent的API接口。

---

#### **六、 信号生成与操作风险管理**

1. 触发机制：严格的人工确认流程  
   信号生成只能通过调用SDK的generate\_trading\_signals函数或未来Web界面的“生成”按钮发起。系统必须实现二次确认机制（例如，在SDK中要求用户输入“YES”确认，在Web端弹出密码确认框）。  
2. 前置风控校验  
   在执行信号生成前，系统必须自动完成以下“飞行前检查”：  
   * **数据完备性检查**：检查当日所需数据的缺失率，若超过预设阈值（如5%），则阻断流程并告警。  
   * **因子异常值检查**：检查核心因子当日数值的分布是否在历史合理范围内（如均值±5σ），若有异常，需弹窗提示用户选择“强制生成”或“终止”。  
3. 核心特性：输出可解释的因子暴露度  
   最终生成的信号文件（CSV/JSON格式），除了股票代码、买卖方向、权重等基础字段外，必须包含一个名为 factor\_exposure 的字段。该字段以JSON字符串形式，记录该股票在构成最终信号的各个底层因子上的归因得分，例如：{"动量因子": 0.85, "估值因子": \-0.42, "质量因子": 0.67}。此设计旨在增强信号的可解释性，为投资经理的决策提供深度支持。  
4. **过程反馈与结果输出**  
   * **进度反馈**：在SDK或Web端实时反馈计算进度。  
   * **结果输出**：输出格式为CSV和JSON，并按触发时间戳进行归档管理。  
5. 操作审计：不可篡改的日志  
   所有信号生成的操作（触发时间、操作员、风控检查结果、是否强制执行、输出文件路径等），均需记录至独立的、不可篡改的审计日志数据库中，并提供查询接口。

**技术实现要点 (基于Hikyuu框架)**

* **信号生成**：利用Hikyuu的交易系统组件，如SYS\_Simple，结合自定义的信号指示器（SG）、资金管理策略（MM）和交易账户（TM）来生成原始交易指令。  
* **风控与暴露度**：前置风控检查和因子暴露度的计算，是在调用Hikyuu的sys.run()方法之前或之后，在Python应用层代码中实现的。这部分逻辑负责准备数据、执行校验，并在Hikyuu生成结果后进行后处理和丰富化。

---

#### **七、 性能与扩展性**

1. **性能目标 (细化)** (在8核CPU/32G内存服务器上)  
   * **因子计算**：全市场10年历史单因子计算，**纯计算时间**应小于30分钟。  
   * **信号生成**：手工触发当日全市场信号，**数据获取时间 \+ 计算时间**总耗时不应超过15分钟。需对这两个阶段耗时分别进行监控和记录。  
2. **扩展性设计**  
   * **自定义因子**：提供register\_custom\_factor()接口，允许用户通过字符串公式或提交Python函数的方式注册新因子。  
   * **数据插件化**：严格遵守AbstractDataProvider接口设计，确保未来可以平滑接入新的数据源。

**技术实现要点 (基于Hikyuu框架)**

* **性能与实现**：所有功能的实现均通过 Hikyuu 的 Python API 层进行，以利用其对底层 C++ 核心的高效封装。对于 Hikyuu 未原生支持的功能（如横截面处理），应在 Python 层结合高性能库（如 Pandas, Polars）进行实现。  
* **扩展性**：register\_custom\_factor接口的实现，可以通过Python动态创建并注册新的指标类。数据插件化的AbstractDataProvider接口是应用层设计，与Hikyuu框架本身解耦，保证了架构的开放性。

---

#### **八、 实施路线图与范围**

1. 一期核心目标 (MVP)  
   构建一个稳定、可靠、无前视偏差的因子验证框架，并跑通包含人工确认、风控校验、因子暴露度输出、操作审计在内的全套信号生成流程。  
2. **开发优先级**  
   * **P0 (最高)**：数据层（特别是Point-in-Time改造和数据源适配）、因子计算层、因子验证层、信号生成核心流程（含风控与审计）。  
   * **P1 (高)**：完善的预设因子库、自动化验证报告、参数化的横截面计算功能。  
   * **P2 (中)**：Web可视化界面、另类数据集成。  
3. **本期明确排除范围**  
   * 基于Level-2数据的原始计算。  
   * 新闻舆情等非结构化另类数据的获取与处理。  
   * 全自动交易与实盘对接。  
   * 投资组合级别的回测与模拟。

---

#### **九、 开发规范与辅助工具**

1. 开发问询机制  
   为确保开发过程高效、规范，所有针对 Hikyuu 框架的技术问题，需遵循以下问询路径：  
   * **(1) hikyuu-mysql mcp**: 用于查询 Hikyuu 框架在 MySQL 中的数据结构与存储细节，解决数据层面的使用问题。  
   * **(2) deepwiki mcp**: 用于向 deepwiki 咨询 Hikyuu 框架的使用问题和排查错误。例如：查询 Hikyuu 是否支持特定功能、如何正确使用某个函数、请求提供功能实现的代码示例等。  
2. **文档管理**  
   * **帮助文档路径**: 项目的所有内部帮助文档、手册和说明，统一存放于项目根目录下的 docs/manu 路径中。


#### **引用的著作**

1. Hikyuu Quant Framework 基于C++/Python的极速开源量化交易研究框架，同时可基于策略部件进行资产重用 \- GitHub, 访问时间为 九月 19, 2025， [https://github.com/fasiondog/hikyuu](https://github.com/fasiondog/hikyuu)  
2. fasiondog/hikyuu \- Gitee, 访问时间为 九月 19, 2025， [https://gitee.com/fasiondog/hikyuu/blob/master/xmake.lua](https://gitee.com/fasiondog/hikyuu/blob/master/xmake.lua)  
3. Hikyuu Quant Framework \- Read the Docs, 访问时间为 九月 19, 2025， [https://hikyuu.readthedocs.io/zh-cn/latest/index.html](https://hikyuu.readthedocs.io/zh-cn/latest/index.html)
